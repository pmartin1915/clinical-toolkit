name: Security Scanning & Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scans daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  dependency-security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: |
        echo "üîç Running dependency security audit..."
        npm audit --audit-level=moderate --json > audit-results.json || true

        # Parse and display critical vulnerabilities
        if [ -f audit-results.json ]; then
          CRITICAL=$(cat audit-results.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical")) | length' 2>/dev/null || echo "0")
          HIGH=$(cat audit-results.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "high")) | length' 2>/dev/null || echo "0")

          echo "üîí Security Audit Results:"
          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ö†Ô∏è Security vulnerabilities found - manual review required"
            npm audit --audit-level=high
          else
            echo "‚úÖ No critical or high severity vulnerabilities found"
          fi
        fi

    - name: Check for known vulnerable packages
      run: |
        echo "üõ°Ô∏è Checking for known vulnerable packages..."

        # Check for commonly vulnerable packages in medical applications
        if npm list | grep -E "(crypto-js@[3-4]\.|lodash@[3-4]\.|moment@[1-2]\.)"; then
          echo "‚ö†Ô∏è Potentially vulnerable versions of critical packages detected"
        else
          echo "‚úÖ No known vulnerable package versions detected"
        fi

    - name: Validate Capacitor plugins security
      run: |
        echo "üì± Validating Capacitor plugins security..."

        # Check Capacitor core and plugins versions
        if npm list @capacitor/core @capacitor/android @capacitor/ios 2>/dev/null; then
          echo "‚úÖ Capacitor plugins found"

          # Check for outdated Capacitor versions
          CAPACITOR_VERSION=$(npm list @capacitor/core --depth=0 2>/dev/null | grep @capacitor/core | sed 's/.*@//' | sed 's/ .*//' || echo "unknown")
          echo "Capacitor version: $CAPACITOR_VERSION"

          if [[ "$CAPACITOR_VERSION" =~ ^[1-5]\. ]]; then
            echo "‚ö†Ô∏è Capacitor version may be outdated - consider upgrading"
          else
            echo "‚úÖ Capacitor version appears current"
          fi
        else
          echo "‚ö†Ô∏è Capacitor not detected in dependencies"
        fi

  code-security-analysis:
    name: Static Code Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for CodeQL

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-extended,security-and-quality

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application for analysis
      run: npm run build

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"

  medical-data-security:
    name: Medical Data Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate data security patterns
      run: |
        echo "üè• Medical data security validation..."

        # Check for proper data storage patterns
        echo "Checking secure storage implementation..."
        if grep -r "localStorage\|sessionStorage" src/ --include="*.ts" --include="*.tsx" | grep -v "test\|spec\|\.test\|\.spec"; then
          echo "‚ö†Ô∏è Direct localStorage/sessionStorage usage found - ensure proper data handling"
        else
          echo "‚úÖ No direct browser storage usage found"
        fi

        # Check for data sanitization in medical calculators
        echo "Checking input sanitization in calculators..."
        if [ -d "src/utils/calculators" ]; then
          if grep -r "sanitize\|validate\|isNaN\|typeof" src/utils/calculators/ --include="*.ts"; then
            echo "‚úÖ Input validation patterns found in calculators"
          else
            echo "‚ö†Ô∏è Input validation patterns not clearly identified in calculators"
          fi
        fi

    - name: HIPAA compliance patterns check
      run: |
        echo "üîí HIPAA compliance patterns check..."

        # Check for potential data logging
        if grep -r "console\.log.*patient\|console\.log.*medical\|console\.log.*PHI" src/ --include="*.ts" --include="*.tsx" | grep -v "test\|spec"; then
          echo "‚ö†Ô∏è Potential sensitive data logging found - HIPAA violation risk"
        else
          echo "‚úÖ No obvious sensitive data logging found"
        fi

        # Check for secure data transmission patterns
        if grep -r "fetch\|axios\|XMLHttpRequest" src/ --include="*.ts" --include="*.tsx" | head -5; then
          echo "‚ö†Ô∏è Network requests found - ensure HTTPS and proper authentication"
        else
          echo "‚úÖ No direct network requests found"
        fi

    - name: Capacitor security validation
      run: |
        echo "üì± Capacitor security validation..."

        # Check for native bridge security
        if [ -d "android" ] || [ -d "ios" ]; then
          echo "Native platforms detected - validating security configurations..."

          # Check Android security config
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            if grep -q "android:usesCleartextTraffic" android/app/src/main/AndroidManifest.xml; then
              echo "‚ö†Ô∏è Cleartext traffic enabled in Android - security risk"
            else
              echo "‚úÖ Cleartext traffic not explicitly enabled"
            fi
          fi

          # Check for secure communication
          if grep -r "Capacitor\.Plugins\|CapacitorHttp" src/ --include="*.ts"; then
            echo "‚úÖ Using Capacitor HTTP plugin (recommended)"
          fi
        fi

  penetration-testing-prep:
    name: Penetration Testing Preparation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Security headers analysis
      run: |
        echo "üõ°Ô∏è Security headers analysis preparation..."

        # Check if security headers are configured
        if [ -f "vite.config.ts" ] || [ -f "vite.config.js" ]; then
          if grep -q "headers" vite.config.*; then
            echo "‚úÖ Security headers configuration found in Vite config"
          else
            echo "‚ö†Ô∏è Security headers not found - configure in deployment"
          fi
        fi

    - name: Input validation testing preparation
      run: |
        echo "üîç Input validation testing vectors..."

        # Create test vectors for penetration testing
        cat > security-test-vectors.md << 'EOF'
        # Security Test Vectors for Clinical Toolkit

        ## Medical Calculator Input Testing
        - Age: negative values, extremely high values (>150), non-numeric, zero
        - Weight/Height: negative values, zero, extremely high values
        - Blood pressure: out-of-range values, malformed input
        - Lab values: negative values, extremely high values, precision testing

        ## Clinical Data Input Testing
        - Patient identifiers: SQL injection patterns, XSS attempts
        - Free-text fields: Script injection, HTML injection
        - Date inputs: Invalid dates, future dates where inappropriate
        - Numeric ranges: Boundary testing for all medical ranges

        ## Session Management Testing
        - Session timeout behavior
        - Multiple tab/window handling
        - Browser refresh/navigation scenarios
        - Mobile app lifecycle (background/foreground)

        ## XSS/Injection Testing
        - Script injection in text fields
        - HTML injection in notes fields
        - SQL injection patterns (if applicable)
        - Command injection attempts

        ## CSRF Testing
        - Cross-origin request patterns
        - State modification attempts

        ## Mobile-Specific Testing (Capacitor)
        - Deep link handling
        - Intent/scheme hijacking
        - File system access
        - Camera/photo library access
        - Background data access

        ## API Security Testing
        - Authentication bypass attempts
        - Authorization escalation
        - Rate limiting validation
        - Token expiration handling
        EOF

        echo "üìã Security test vectors created: security-test-vectors.md"

    - name: Create security testing artifact
      uses: actions/upload-artifact@v4
      with:
        name: security-test-vectors
        path: security-test-vectors.md
        retention-days: 30

  security-compliance-report:
    name: Security Compliance Report
    runs-on: ubuntu-latest
    needs: [dependency-security, code-security-analysis, medical-data-security, penetration-testing-prep]
    if: always()

    steps:
    - name: Generate security compliance report
      run: |
        echo "üõ°Ô∏è Security Compliance Report"
        echo "============================="
        echo ""
        echo "**Clinical Toolkit Security Assessment**"
        echo ""

        # Dependency Security Results
        if [ "${{ needs.dependency-security.result }}" = "success" ]; then
          echo "‚úÖ **Dependency Security**: PASSED"
          echo "   - No critical vulnerabilities in dependencies"
          echo "   - Capacitor plugins validated"
        else
          echo "‚ùå **Dependency Security**: ATTENTION REQUIRED"
          echo "   - Manual review of dependency vulnerabilities needed"
        fi
        echo ""

        # Code Analysis Results
        if [ "${{ needs.code-security-analysis.result }}" = "success" ]; then
          echo "‚úÖ **Static Code Analysis**: PASSED"
          echo "   - CodeQL security analysis completed"
          echo "   - No critical security patterns detected"
        else
          echo "‚ùå **Static Code Analysis**: ATTENTION REQUIRED"
          echo "   - Review CodeQL security findings"
        fi
        echo ""

        # Medical Data Security Results
        if [ "${{ needs.medical-data-security.result }}" = "success" ]; then
          echo "‚úÖ **Medical Data Security**: PASSED"
          echo "   - Data handling patterns validated"
          echo "   - HIPAA compliance patterns checked"
          echo "   - Capacitor security validated"
        else
          echo "‚ùå **Medical Data Security**: ATTENTION REQUIRED"
          echo "   - Review medical data handling patterns"
        fi
        echo ""

        # Penetration Testing Prep Results
        if [ "${{ needs.penetration-testing-prep.result }}" = "success" ]; then
          echo "‚úÖ **Penetration Testing Prep**: COMPLETED"
          echo "   - Test vectors generated"
          echo "   - Security configuration reviewed"
        else
          echo "‚ùå **Penetration Testing Prep**: INCOMPLETE"
        fi
        echo ""

        # Overall Security Posture
        PASSED_COUNT=0
        if [ "${{ needs.dependency-security.result }}" = "success" ]; then PASSED_COUNT=$((PASSED_COUNT + 1)); fi
        if [ "${{ needs.code-security-analysis.result }}" = "success" ]; then PASSED_COUNT=$((PASSED_COUNT + 1)); fi
        if [ "${{ needs.medical-data-security.result }}" = "success" ]; then PASSED_COUNT=$((PASSED_COUNT + 1)); fi
        if [ "${{ needs.penetration-testing-prep.result }}" = "success" ]; then PASSED_COUNT=$((PASSED_COUNT + 1)); fi

        echo "üéØ **Overall Security Posture**: $PASSED_COUNT/4 checks passed"
        echo ""

        if [ "$PASSED_COUNT" -eq 4 ]; then
          echo "üü¢ **SECURITY STATUS**: GOOD - Ready for deployment"
        elif [ "$PASSED_COUNT" -ge 3 ]; then
          echo "üü° **SECURITY STATUS**: CAUTION - Address remaining issues"
        else
          echo "üî¥ **SECURITY STATUS**: CRITICAL - Do not deploy until issues resolved"
        fi
        echo ""
        echo "**Next Steps:**"
        echo "1. Review any failed security checks"
        echo "2. Address identified vulnerabilities"
        echo "3. Consider professional penetration testing"
        echo "4. Implement security monitoring in production"
        echo "5. Validate Capacitor plugin permissions"
