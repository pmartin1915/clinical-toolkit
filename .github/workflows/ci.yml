name: Clinical Wizard CI/CD

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  lint:
    name: Code Quality (Lint)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:run

      - name: Generate coverage report
        run: npm run test:coverage
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-clinical-wizard
        continue-on-error: true

      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  build-web:
    name: Build Web Application
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web application
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not created"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "Error: index.html not found in dist"
            exit 1
          fi
          echo "Build verification successful"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/
          retention-days: 7

      - name: Check bundle size
        run: |
          echo "Bundle size analysis:"
          du -sh dist/
          find dist/assets -name "*.js" -exec ls -lh {} \; | awk '{print $5 "\t" $9}'

  capacitor-sync:
    name: Capacitor Android Sync
    runs-on: ubuntu-latest
    needs: build-web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web application
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Verify Android directory
        run: |
          if [ ! -d "android" ]; then
            echo "Error: android directory not found"
            exit 1
          fi
          if [ ! -f "android/app/build.gradle" ]; then
            echo "Error: Android build.gradle not found"
            exit 1
          fi
          echo "Capacitor sync verification successful"

      - name: Run Capacitor Doctor
        run: npx cap doctor
        continue-on-error: true

  android-build:
    name: Android APK Build (Debug)
    runs-on: ubuntu-latest
    needs: capacitor-sync

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Build web application
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build Android Debug APK
        run: cd android && ./gradlew assembleDebug --no-daemon

      - name: Verify APK exists
        run: |
          if [ ! -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "Error: Debug APK not found"
            exit 1
          fi
          echo "Android APK build successful"
          ls -lh android/app/build/outputs/apk/debug/app-debug.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [lint, test, build-web, capacitor-sync]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Build Web: ${{ needs.build-web.result }}"
          echo "Capacitor Sync: ${{ needs.capacitor-sync.result }}"

          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "âŒ Lint check failed"
            exit 1
          fi

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ Tests failed"
            exit 1
          fi

          if [ "${{ needs.build-web.result }}" != "success" ]; then
            echo "âŒ Web build failed"
            exit 1
          fi

          if [ "${{ needs.capacitor-sync.result }}" != "success" ]; then
            echo "âŒ Capacitor sync failed"
            exit 1
          fi

          echo "âœ… All quality gates passed!"

      - name: Summary
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web Build | ${{ needs.build-web.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Capacitor Sync | ${{ needs.capacitor-sync.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All quality gates passed! ðŸŽ‰**" >> $GITHUB_STEP_SUMMARY
