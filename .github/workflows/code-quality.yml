name: Code Quality & Standards

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly quality checks on main branch
    - cron: '0 2 * * 1'  # Monday 2 AM UTC
  workflow_dispatch:

jobs:
  lint-and-format:
    name: Linting & Formatting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: |
        echo "üîç Running ESLint with medical-specific rules..."
        npm run lint -- --format=github

    - name: Check TypeScript compilation
      run: |
        echo "üîß Checking TypeScript compilation..."
        tsc -b

    - name: Validate import organization
      run: |
        echo "üì¶ Checking import organization..."
        # Check for circular dependencies
        npx madge --circular --extensions ts,tsx src/ || echo "‚ö†Ô∏è Circular dependencies detected"
        echo "‚úÖ Import validation completed"

    - name: Check for TODOs and FIXMEs
      run: |
        echo "üìù Scanning for TODO/FIXME comments..."
        TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX\|HACK" src/ --include="*.ts" --include="*.tsx" | wc -l || echo "0")
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "‚ö†Ô∏è Found $TODO_COUNT TODO/FIXME comments:"
          grep -r "TODO\|FIXME\|XXX\|HACK" src/ --include="*.ts" --include="*.tsx" || true
        else
          echo "‚úÖ No TODO/FIXME comments found"
        fi

  medical-code-standards:
    name: Medical Code Standards
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate medical calculation functions
      run: |
        echo "ü©∫ Validating medical calculation code standards..."

        # Check for proper JSDoc documentation on medical functions
        echo "Checking for JSDoc on critical medical functions..."
        if ! grep -r "@param\|@returns\|@description" src/utils/calculators/ --include="*.ts" 2>/dev/null; then
          echo "‚ö†Ô∏è Medical functions may lack proper documentation"
        else
          echo "‚úÖ Medical function documentation found"
        fi

        # Check for unit/range validations in medical functions
        echo "Checking for input validation in medical functions..."
        if grep -r "zod\|validate\|isNaN\|typeof" src/utils/calculators/ --include="*.ts" > /dev/null 2>&1; then
          echo "‚úÖ Input validation found in medical functions"
        else
          echo "‚ö†Ô∏è Medical functions may lack input validation"
        fi

    - name: Security code patterns check
      run: |
        echo "üîí Checking for secure coding patterns..."

        # Check for hardcoded secrets or keys
        if grep -r "password\|secret\|key.*=\|api.*key" src/ --include="*.ts" --include="*.tsx" | grep -v "keyof\|keyboard\|keydown\|keyup" | grep -v "test\|spec"; then
          echo "‚ö†Ô∏è Potential hardcoded secrets found - manual review required"
        else
          echo "‚úÖ No hardcoded secrets detected"
        fi

        # Check for proper error handling
        if ! grep -r "try.*catch\|throw.*Error" src/ --include="*.ts" > /dev/null; then
          echo "‚ö†Ô∏è Limited error handling found in core modules"
        else
          echo "‚úÖ Error handling patterns found"
        fi

    - name: Performance patterns check
      run: |
        echo "‚ö° Checking for performance anti-patterns..."

        # Check for potential performance issues
        PERF_ISSUES=0

        # Look for excessive re-renders patterns
        if grep -r "useEffect.*\[\]" src/components/ --include="*.tsx" | wc -l | awk '{if($1>5) print "‚ö†Ô∏è Many useEffect with empty deps found"}' > /dev/null; then
          PERF_ISSUES=$((PERF_ISSUES + 1))
        fi

        # Look for inline object/function definitions in JSX
        if grep -r "onClick={.*=>.*}" src/components/ --include="*.tsx" | head -3 | grep -q "=>"; then
          echo "‚ö†Ô∏è Inline functions in JSX may impact performance"
          PERF_ISSUES=$((PERF_ISSUES + 1))
        fi

        if [ "$PERF_ISSUES" -eq 0 ]; then
          echo "‚úÖ No obvious performance anti-patterns found"
        else
          echo "‚ö†Ô∏è $PERF_ISSUES potential performance issues found - review recommended"
        fi

  accessibility-check:
    name: Accessibility Standards
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Medical accessibility validation
      run: |
        echo "‚ôø Validating medical application accessibility..."

        # Check for form accessibility
        echo "Checking form accessibility patterns..."
        if grep -r "aria-label\|aria-describedby\|htmlFor" src/components/ --include="*.tsx" > /dev/null; then
          echo "‚úÖ Accessibility attributes found in components"
        else
          echo "‚ö†Ô∏è Limited accessibility attributes found"
        fi

        # Check for keyboard navigation support
        if grep -r "onKeyDown\|onKeyPress\|tabIndex" src/components/ --include="*.tsx" > /dev/null; then
          echo "‚úÖ Keyboard navigation patterns found"
        else
          echo "‚ö†Ô∏è Limited keyboard navigation support found"
        fi

        # Check for screen reader support
        if grep -r "aria-live\|role=\|aria-expanded" src/components/ --include="*.tsx" > /dev/null; then
          echo "‚úÖ Screen reader support patterns found"
        else
          echo "‚ö†Ô∏è Limited screen reader support found"
        fi

    - name: Run accessibility linting
      run: |
        echo "Running jsx-a11y accessibility checks..."
        npm run lint -- --ext .tsx --no-fix | grep "jsx-a11y" || echo "‚úÖ No accessibility linting errors"

  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Analyze medical calculation complexity
      run: |
        echo "üßÆ Analyzing medical calculation complexity..."

        # Focus on critical medical calculation files
        if [ -d "src/utils/calculators" ]; then
          echo "Checking medical calculator complexity..."
          find src/utils/calculators -name "*.ts" -exec wc -l {} \; | awk '$1 > 300 {print "‚ö†Ô∏è Large calculator file: " $2 " (" $1 " lines)"}'
        fi

        echo "‚úÖ Complexity analysis completed"

    - name: Component size analysis
      run: |
        echo "üìè Analyzing component sizes..."

        # Check for overly large components (>500 lines)
        find src/components/ -name "*.tsx" -exec wc -l {} \; | awk '$1 > 500 {print "‚ö†Ô∏è Large component: " $2 " (" $1 " lines)"}' || echo "‚úÖ No oversized components found"

    - name: Bundle analysis preparation
      run: |
        echo "üì¶ Preparing bundle analysis..."
        npm run build

        # Check total bundle size
        if [ -d "dist/assets" ]; then
          echo "üìä Bundle analysis:"
          du -sh dist/assets/ 2>/dev/null || echo "No assets directory found"

          # List largest assets
          echo "üìã Largest assets:"
          find dist/assets -name "*.js" -exec du -h {} \; 2>/dev/null | sort -hr | head -5 || echo "No JS assets found"
        fi

    - name: Capacitor configuration check
      run: |
        echo "üì± Checking Capacitor configuration..."

        # Check for Capacitor config
        if [ -f "capacitor.config.ts" ] || [ -f "capacitor.config.json" ]; then
          echo "‚úÖ Capacitor configuration found"

          # Check for required Capacitor directories
          if [ -d "android" ]; then
            echo "‚úÖ Android platform configured"
          else
            echo "‚ö†Ô∏è Android platform not configured"
          fi

          if [ -d "ios" ]; then
            echo "‚úÖ iOS platform configured"
          else
            echo "‚ö†Ô∏è iOS platform not configured"
          fi
        else
          echo "‚ö†Ô∏è Capacitor configuration not found"
        fi

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, medical-code-standards, accessibility-check, complexity-analysis]
    if: always()

    steps:
    - name: Quality gate summary
      run: |
        echo "üìä Code Quality Summary"
        echo "======================"
        echo ""

        if [ "${{ needs.lint-and-format.result }}" = "success" ]; then
          echo "‚úÖ Linting & Formatting: PASSED"
        else
          echo "‚ùå Linting & Formatting: FAILED"
        fi

        if [ "${{ needs.medical-code-standards.result }}" = "success" ]; then
          echo "‚úÖ Medical Code Standards: PASSED"
        else
          echo "‚ùå Medical Code Standards: FAILED"
        fi

        if [ "${{ needs.accessibility-check.result }}" = "success" ]; then
          echo "‚úÖ Accessibility Standards: PASSED"
        else
          echo "‚ùå Accessibility Standards: FAILED"
        fi

        if [ "${{ needs.complexity-analysis.result }}" = "success" ]; then
          echo "‚úÖ Complexity Analysis: PASSED"
        else
          echo "‚ùå Complexity Analysis: FAILED"
        fi

        echo ""
        echo "üéØ Overall Quality Gate: $(if [ "${{ needs.lint-and-format.result }}" = "success" ] && [ "${{ needs.medical-code-standards.result }}" = "success" ]; then echo "PASSED ‚úÖ"; else echo "REVIEW REQUIRED ‚ö†Ô∏è"; fi)"
