import { test, expect } from '@playwright/test';
// import { injectAxe, checkA11y } from '@axe-core/playwright'; // TODO: Update to correct API
import { testA1CData, testPatients, testCHA2DS2VAScData } from './fixtures/medical-test-data';

/**
 * E2E Tests for Clinical Toolkit Calculator Workflows
 *
 * Tests critical calculator functionality to ensure:
 * 1. Calculators load correctly
 * 2. Input validation works
 * 3. Calculations produce expected results
 * 4. Accessibility compliance (axe-core)
 * 5. Educational disclaimers are present
 */

test.describe('Clinical Toolkit - Calculator Workflows', () => {

  test.beforeEach(async ({ page }) => {
    // Navigate to the app
    await page.goto('/');

    // Wait for dashboard to load
    await expect(page.getByText(/Clinical Toolkit|Welcome/i)).toBeVisible({ timeout: 10000 });

    // Close welcome modal if it appears
    const welcomeModal = page.locator('[role="dialog"]');
    if (await welcomeModal.isVisible()) {
      const acceptButton = page.getByRole('button', { name: /accept|agree|continue|close/i });
      if (await acceptButton.isVisible()) {
        await acceptButton.click();
        await expect(welcomeModal).not.toBeVisible();
      }
    }

    // Inject accessibility checker
    // await injectAxe(page);
  });

  test('Dashboard loads successfully', async ({ page }) => {
    // Check that dashboard elements are present
    await expect(page.locator('h1, h2').first()).toBeVisible();

    // Verify quick actions are present
    await expect(page.getByText(/Heart Risk|A1C to Glucose|Mood Check|Anxiety Check/i)).toBeVisible();

    // Check accessibility
    // await checkA11y(page, null, {
detailedReportOptions: { html: true }
  });

  test('A1C Converter - Normal Range', async ({ page }) => {
    // Click on A1C Converter quick action
    await page.getByText(/A1C to Glucose/i).click();

    // Wait for calculator to load
    await expect(page.getByText(/A1C/i)).toBeVisible();

    // Find the A1C input field (may vary based on implementation)
    const a1cInput = page.locator('input[type="number"]').first();
    await expect(a1cInput).toBeVisible();

    // Enter normal A1C value
    await a1cInput.fill(testA1CData.normal.a1c.toString());

    // Look for calculate button if it exists, or wait for auto-calculation
    const calculateButton = page.getByRole('button', { name: /calculate/i });
    if (await calculateButton.isVisible()) {
      await calculateButton.click();
    }

    // Wait a moment for calculation
    await page.waitForTimeout(500);

    // Verify result is displayed (within reasonable range)
    const resultText = await page.textContent('body');
    expect(resultText).toMatch(/\d+/); // Should contain numbers

    // Check for educational disclaimer
    expect(resultText).toMatch(/educational|not for clinical use|consult|healthcare professional/i);

    // Check accessibility`n    // await checkA11y(page);`n  });

  test('A1C Converter - Diabetic Range', async ({ page }) => {
    await page.getByText(/A1C to Glucose/i).click();
    await expect(page.getByText(/A1C/i)).toBeVisible();

    const a1cInput = page.locator('input[type="number"]').first();
    await a1cInput.fill(testA1CData.diabetic.a1c.toString());

    const calculateButton = page.getByRole('button', { name: /calculate/i });
    if (await calculateButton.isVisible()) {
      await calculateButton.click();
    }

    await page.waitForTimeout(500);

    // Verify diabetic range indicator is shown
    const resultText = await page.textContent('body');
    expect(resultText).toMatch(/diabetic|elevated|high|concern/i);
  });

  test('Enhanced ASCVD Calculator - Low Risk Patient', async ({ page }) => {
    // Click on Heart Risk calculator
    await page.getByText(/Heart Risk/i).click();

    // Wait for calculator to load
    await expect(page.getByText(/ASCVD|cardiovascular|risk/i)).toBeVisible();

    // Fill in patient data for low-risk patient
    const patient = testPatients.lowRiskMale;

    // Age input
    const ageInput = page.locator('input[type="number"]').filter({ hasText: '' }).or(page.getByLabel(/age/i));
    if (await ageInput.count() > 0) {
      await ageInput.first().fill(patient.age.toString());
    }

    // Gender selection
    const maleRadio = page.getByLabel(/male/i).first();
    if (await maleRadio.isVisible()) {
      await maleRadio.check();
    }

    // Total cholesterol
    const totalCholInput = page.locator('input').filter({ hasText: '' });
    if (await totalCholInput.count() > 1) {
      await totalCholInput.nth(1).fill(patient.totalCholesterol.toString());
    }

    // Calculate
    const calculateButton = page.getByRole('button', { name: /calculate/i });
    if (await calculateButton.isVisible()) {
      await calculateButton.click();
      await page.waitForTimeout(1000);
    }

    // Verify low risk result is shown
    const resultText = await page.textContent('body');
    expect(resultText).toMatch(/risk|%/i);

    // Check for educational disclaimer
    expect(resultText).toMatch(/educational|not for clinical use/i);
  });

  test('CHA2DS2-VASc Calculator Accessibility', async ({ page }) => {
    // Navigate to hypertension condition (which includes CHA2DS2-VASc)
    await page.getByText(/hypertension|high blood pressure/i).first().click();

    // Wait for condition page to load
    await page.waitForTimeout(1000);

    // Look for CHA2DS2-VASc calculator
    const cha2ds2Text = page.getByText(/CHA2DS2|stroke risk/i);
    if (await cha2ds2Text.isVisible()) {
      await cha2ds2Text.click();
      await page.waitForTimeout(500);

      // Check accessibility of the calculator`n      // await checkA11y(page);`n    }
  });

  test('PHQ-9 Depression Screening', async ({ page }) => {
    // Click on Mood Check quick action
    await page.getByText(/Mood Check/i).click();

    // Wait for PHQ-9 to load
    await expect(page.getByText(/PHQ-9|depression|mood/i)).toBeVisible();

    // Verify all 9 questions are present
    const questions = page.locator('input[type="radio"], select');
    expect(await questions.count()).toBeGreaterThan(0);

    // Fill out minimal screening (select first option for each question)
    const radios = page.locator('input[type="radio"]');
    const radioCount = await radios.count();

    if (radioCount > 0) {
      // Select "Not at all" for first few questions (minimal score)
      for (let i = 0; i < Math.min(9, radioCount); i += 4) {
        await radios.nth(i).check();
      }

      // Calculate
      const calculateButton = page.getByRole('button', { name: /calculate|submit|score/i });
      if (await calculateButton.isVisible()) {
        await calculateButton.click();
        await page.waitForTimeout(500);
      }

      // Verify result
      const resultText = await page.textContent('body');
      expect(resultText).toMatch(/score|minimal|mild|moderate|severe/i);
    }

    // Check for crisis resources/disclaimer
    const bodyText = await page.textContent('body');
    expect(bodyText).toMatch(/educational|healthcare professional|emergency/i);
  });

  test('GAD-7 Anxiety Screening', async ({ page }) => {
    // Click on Anxiety Check quick action
    await page.getByText(/Anxiety Check/i).click();

    // Wait for GAD-7 to load
    await expect(page.getByText(/GAD-7|anxiety|worry/i)).toBeVisible();

    // Verify questions are present
    const questions = page.locator('input[type="radio"], select');
    expect(await questions.count()).toBeGreaterThan(0);

    // Check accessibility
    // await checkA11y(page);

    // Verify educational disclaimer
    const bodyText = await page.textContent('body');
    expect(bodyText).toMatch(/educational|not for clinical use|screening/i);
  });

  test('Blood Pressure Tracker', async ({ page }) => {
    // Click on BP Tracker quick action
    await page.getByText(/Check Blood Pressure|BP/i).click();

    // Wait for BP tracker to load
    await page.waitForTimeout(1000);

    // Look for systolic/diastolic inputs
    const inputs = page.locator('input[type="number"]');
    if (await inputs.count() >= 2) {
      // Enter normal BP values
      await inputs.first().fill('120');
      await inputs.nth(1).fill('80');

      // Look for submit/add button
      const submitButton = page.getByRole('button', { name: /add|submit|save|track/i });
      if (await submitButton.isVisible()) {
        await submitButton.click();
        await page.waitForTimeout(500);

        // Verify result category (should show "Normal")
        const resultText = await page.textContent('body');
        expect(resultText).toMatch(/normal|optimal|healthy/i);
      }
    }
  });

  test('Navigation between calculators', async ({ page }) => {
    // Test navigation flow
    await page.getByText(/A1C to Glucose/i).click();
    await expect(page.getByText(/A1C/i)).toBeVisible();

    // Navigate back to dashboard
    const backButton = page.getByRole('button', { name: /back|home|dashboard/i });
    if (await backButton.isVisible()) {
      await backButton.click();
    } else {
      // Try clicking logo or header link
      await page.getByRole('link', { name: /clinical toolkit|home/i }).first().click();
    }

    // Verify back on dashboard
    await expect(page.getByText(/Heart Risk|A1C to Glucose/i)).toBeVisible();

    // Navigate to another calculator
    await page.getByText(/Heart Risk/i).click();
    await expect(page.getByText(/ASCVD|cardiovascular/i)).toBeVisible();
  });

  test('Mobile responsiveness', async ({ page }) => {
    // Set mobile viewport
    await page.setViewportSize({ width: 375, height: 667 });

    // Verify dashboard is usable on mobile
    await expect(page.getByText(/Heart Risk|A1C to Glucose/i)).toBeVisible();

    // Click a calculator
    await page.getByText(/A1C to Glucose/i).click();
    await expect(page.getByText(/A1C/i)).toBeVisible();

    // Verify input fields are accessible
    const inputs = page.locator('input[type="number"]');
    expect(await inputs.count()).toBeGreaterThan(0);

    // Check accessibility on mobile
    // await checkA11y(page);
  });

  test('Educational disclaimer is always present', async ({ page }) => {
    const calculators = [
      'A1C to Glucose',
      'Heart Risk',
      'Mood Check',
      'Anxiety Check'
    ];

    for (const calculator of calculators) {
      await page.goto('/');
      await page.waitForTimeout(500);

      // Close welcome modal if present
      const welcomeModal = page.locator('[role="dialog"]');
      if (await welcomeModal.isVisible()) {
        const acceptButton = page.getByRole('button', { name: /accept|agree|continue|close/i });
        if (await acceptButton.isVisible()) {
          await acceptButton.click();
        }
      }

      await page.getByText(calculator).click();
      await page.waitForTimeout(1000);

      // Verify disclaimer is present
      const bodyText = await page.textContent('body');
      expect(bodyText).toMatch(/educational|not for clinical use|healthcare professional/i);
    }

});

/**
 * Test Suite: Error Handling and Edge Cases
 */
test.describe('Calculator Error Handling', () => {

  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    await page.waitForTimeout(1000);

    // Close welcome modal
    const welcomeModal = page.locator('[role="dialog"]');
    if (await welcomeModal.isVisible()) {
      const acceptButton = page.getByRole('button', { name: /accept|agree|continue|close/i });
      if (await acceptButton.isVisible()) {
        await acceptButton.click();
      }
    }
  });

  test('A1C Calculator - Invalid input handling', async ({ page }) => {
    await page.getByText(/A1C to Glucose/i).click();
    await page.waitForTimeout(500);

    const a1cInput = page.locator('input[type="number"]').first();

    // Try entering invalid value (negative)
    await a1cInput.fill('-1');

    const calculateButton = page.getByRole('button', { name: /calculate/i });
    if (await calculateButton.isVisible()) {
      await calculateButton.click();
      await page.waitForTimeout(500);

      // Should show error or validation message
      const bodyText = await page.textContent('body');
      expect(bodyText).toMatch(/error|invalid|valid|range/i);
    }
  });

  test('Calculator handles empty inputs gracefully', async ({ page }) => {
    await page.getByText(/Heart Risk/i).click();
    await page.waitForTimeout(500);

    // Try to calculate without filling inputs
    const calculateButton = page.getByRole('button', { name: /calculate/i });
    if (await calculateButton.isVisible()) {
      await calculateButton.click();
      await page.waitForTimeout(500);

      // Should either show validation error or disable calculation
      const bodyText = await page.textContent('body');
      // Just verify no crash occurred
      expect(bodyText).toBeTruthy();
    }

});
